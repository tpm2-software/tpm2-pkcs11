#!/usr/bin/env bash
# SPDX-License-Identifier: BSD-2-Clause

source "$T/test/integration/scripts/helpers.sh"

tempdir=$(mktemp -d)

function cleanup() {
	rm -rf "$tempdir"
}
trap cleanup EXIT

onerror() {
  echo "$BASH_COMMAND on line ${BASH_LINENO[0]} failed: $?"
  exit 1
}
trap onerror ERR

setup_asan

if [ -z "$modpath" ]; then
  modpath="$PWD/src/.libs/libtpm2_pkcs11.so"
fi

echo "modpath=$modpath"

pkcs11_tool() {
  pkcs11-tool --module "$modpath" "$@"
  return $?
}

export TPM2_PKCS11_STORE="$tempdir"

echo "TPM2_PKCS11_STORE=$TPM2_PKCS11_STORE"

echo "Should have unitialized token"
pkcs11_tool -T | grep -q uninitialized
echo "Found unitialized token"

echo "Initializing token"
pkcs11_tool --slot=1 --init-token --label=mynewtoken --so-pin=mynewsopin
echo "Token initialized"

echo "Initializing user pin"
pkcs11_tool --slot=1 --login --login-type="so" --init-pin --so-pin=mynewsopin --pin=mynewuserpin
echo "Userpin initialized"

echo "Generating RSA keypair"
pkcs11_tool --slot=1 --label="myrsakey" --login --pin=mynewuserpin --keypairgen
echo "RSA Keypair generated"

exit 0
